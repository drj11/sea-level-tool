<html>
<body>
<a href="http://ilikai.soest.hawaii.edu/uhslc/jasl.html">JASL</a> archive.

<p id="inventory"></p>
<p id="download"></p>
<p id="database"></p>

<div class="ui-widget">
  <label for="station">Station: </label>
  <input id="station" />
</div>

<a id="fetch" class="btn btn-primary">Fetch</a>
<script src="http://coffeescript.org/extras/coffee-script.js"> </script>
<link rel="stylesheet" href="//x.scraperwiki.com/vendor/style/bootstrap.min.css">
<link rel="stylesheet" href="//x.scraperwiki.com/style/scraperwiki.css">
<script src="//x.scraperwiki.com/vendor/js/bootstrap.min.js"></script>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="http://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>
<script src="//x.scraperwiki.com/js/scraperwiki.js"></script>
<script type="text/coffeescript">
plural = (word, n) ->
  if n is 1
    return word
  return word + "s"

freshDownloadCount = () ->
  scraperwiki.exec "{ cd download && ls *.zip;} 2>/dev/null", (data) ->
    n = data.replace(/[^\n]/g, '').length
    # In *l* make a list of identifiers, trimmed to 4 if larger.
    l = data.replace(/\n$/, '').split('\n')
    if l.length > 4
      l = l[..2].concat ['...'], l[-2..]
    stations = l.join ', '
    if stations
      stations = '(' + stations + ') '
    $('#download').html "Files for #{n} #{plural "station", n} #{stations}in <tt>download</tt> directory."

$ ->
  scraperwiki.sql.meta (meta) ->
    if meta?.table?.inventory
      $('#inventory').text "Station Inventory is available."
      scraperwiki.sql "SELECT station,jaslid FROM inventory", (l) ->
        sl = ("#{x.jaslid} #{x.station.trim()}" for x in l)
        $('#station').autocomplete source: sl
        $('#fetch').on 'click', ->
          jaslid = $('#station').val().match(/^(\w+)/)[0]
          scraperwiki.exec "tool/code/etl #{jaslid}", (s) ->
            freshDownloadCount()
  freshDownloadCount()
</script>
</body>
